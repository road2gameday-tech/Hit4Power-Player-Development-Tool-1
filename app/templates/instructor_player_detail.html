{% extends "base.html" %}
{% block title %}Clients â€¢ Hit4Power{% endblock %}
{% block header_title %}<h1 class="page-title">Clients</h1>{% endblock %}

{% block content %}

<section class="panel">
  <h2>My Clients</h2>
  <ul id="my-clients-list" class="my-clients">
    {% if my_clients %}
      {% for p in my_clients %}
        <li>
          <a href="/player?code={{ p.login_code|default('') }}" title="Open as player (requires code on player login)">
            {{ p.first_name }} {{ p.last_name }}
          </a>
          <span class="age-chip">{{ p.age_group }}</span>
        </li>
      {% endfor %}
    {% else %}
      <li class="muted">No clients starred yet.</li>
    {% endif %}
  </ul>
</section>

<section class="panel">
  <div class="panel-head">
    <h2>Create Player</h2>
  </div>
  <form class="form-grid" action="/instructor/create-player" method="post" enctype="multipart/form-data">
    <input name="first_name" placeholder="First name" required>
    <input name="last_name" placeholder="Last name" required>
    <select name="age_group" required>
      {% for g in ["7-9","10-12","13-15","16-18","18+"] %}
      <option value="{{g}}">{{g}}</option>
      {% endfor %}
    </select>
    <input name="email" placeholder="Email">
    <input name="phone" placeholder="Phone">
    <input type="file" name="image" accept="image/*">
    <button class="btn btn-red" type="submit">Create</button>
  </form>
</section>

<section class="panel">
  <h2>Clients by Age Group</h2>

  {% for group, plist in groups.items() %}
  <div class="age-group">
    <div class="age-title">{{ group }}</div>
    {% if plist and plist|length %}
      <ul class="player-list">
        {% for player in plist %}
        <li class="player-row">
          <button class="fav-btn player-fav {{ 'is-fav' if player.id in fav_ids else '' }}"
                  data-player-id="{{ player.id }}" aria-label="Toggle favorite">
            <svg viewBox="0 0 24 24" class="star"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <span class="player-name">{{ player.first_name }} {{ player.last_name }}</span>
          <div class="spacer"></div>
          <a class="btn btn-ghost" href="/player?code={{ player.login_code }}">Manage</a>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="muted">No players in this group yet.</div>
    {% endif %}
  </div>
  {% endfor %}
</section>

{% endblock %}

{% block scripts %}
<script>
(function () {
  function rebuildMyClients(list){
    const ul = document.getElementById('my-clients-list');
    if (!ul) return;
    if (!list || !list.length){
      ul.innerHTML = '<li class="muted">No clients starred yet.</li>';
      return;
    }
    ul.innerHTML = list.map(p =>
      `<li><a href="/player?code=" title="Open as player">${p.name}</a><span class="age-chip">${p.age_group||''}</span></li>`
    ).join('');
  }

  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.player-fav');
    if (!btn) return;
    const pid = btn.dataset.playerId;
    btn.disabled = true;
    try{
      const res = await fetch(`/instructor/favorite/${pid}`, { method: 'POST' });
      const data = await res.json();
      if (data.ok){
        btn.classList.toggle('is-fav', !!data.favorited);
        rebuildMyClients(data.my_clients);
      }
    } catch(err){
      console.error(err);
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
{% endblock %}
